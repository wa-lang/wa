# 凹汇编语言函数调用约定 - 龙芯64平台

设计目标:

- 兼容龙芯64官方ABI
- 和C函数可双向调用

内部细节：

- 增加寄存器传递的参与和返回值的内存布局约定
- 栈的参数和返回值根据类型要求对齐
- SP 寄存器必须 16 字节对齐

## 1. 参数和返回值的类型

- 可通过整数寄存器传递: i32/i64/...
- 可通过浮点数寄存器传递: f32/f64
- 不支持结构体和数组, 需要拆开或者传地址

## 2. 输入参数的寄存器约定

| 分类 | 参数列表  | 寄存器列表       | 说明 |
| ---- | -------- | ---------------- | ---- |
| 1    | n1,n2,n3 | a0,a1,a2         | 全部走整数寄存器
| 2    | f1,f2,f3 | fa0,fa1,fa2      | 全部走浮点数寄存器
| 3    | n1-n9    | a0-a7,stack(n9)  | n1-n8 走寄存器, n9 走栈传递
| 4    | f1,n1,f2 | fa0,a0,fa1       | 整数+浮点数寄存器混合
| 5    | f1-f10   | fa0-fa7,a0,a1    | 浮点数寄存器不足时, 走整数寄存器

- 整数寄存器: a0-a7
- 浮点数寄存器: fa0-fa7
- 浮点数寄存器不足, 可用剩余的整数寄存器
- 寄存器不足, 则走栈传递

## 3. 输入参数的栈布局

### 3.1 寄存器传全部参数

```
+------+
| argN |
+------+
| .... |
+------+
| arg1 |
+------+
| arg0 |
+------+<--- SP
```

- 调用方只预留空间, 并不做填充
- 被调用方, 可用作备份绑定输入参数的寄存器

### 3.2 寄存器传部分参数

```
+------+
| arg7 |
+------+
| .... |
+------+
| arg1 |
+------+
| arg0 |
+------+<--- 以上是走寄存器的参数
| argN |
+------+
| .... |
+------+
| arg9 |
+------+
| arg8 | 走栈的参数已经被填入数据
+------+<--- SP
```

- 调用方只预留空间, 并不做填充
- 走栈的参数已经被填入数据
- 被调用方, 可用作备份绑定输入参数的寄存器
- 参数在栈的排序顺序和定义顺序可能不一致(满足龙芯ABI布局)

## 4. 返回值的传递

- 整数寄存器: a0, a1
- 浮点数寄存器: fa0, fa1
- 寄存器不足时走栈传递, a0对应的地址

### 4.1 返回值栈布局

```
+--------+<--- 以上是返回值
|  ....  |
|  args  | 走栈传递的输入参数
|  ....  |
+--------+<--- 调用函数的 SP, 被调用函数的 FP
|   RA   | 函数返回地址
|   FP   | 上个栈帧备份
+--------+<--- 以下走寄存器返回
|  retN  |
|  ....  |
|  ret1  |
|  ret0  |
+--------+<--- 返回值变量, 也用于栈返回结果
|  argx  |
|  ....  |
|  arg1  |
|  arg0  |
+--------+<--- 走寄存器参数的备份空间
| ...... |
| local1 | 局部变量
| local0 | local0 对齐到 16 字节为 SP
+--------+<--- SP
```

- 多返回值是凹汇编特有, 对应返回结构体, 超过16字节时走栈返回, 栈地址在 a0 寄存器
- 返回值在栈的排序顺序和定义顺序是一致的

## 5. 函数栈帧结构

```
+-------+
| ret   | 返回值
+-------+
| args  | 输入参数
+-------+<--- FP, 被调用函数栈帧开始
|  RA   | 函数返回地址
|  FP   | 前 FP 备份
+-------+
| local | 局部变量
| ..... |
| ----- |
| ret   | 再调用其他函数的参数
| args  |
+-------+<--- SP, 被调用函数栈帧结束
```

- 输入参数由调用者分配, 被调用者可以使用
- 被调用函数栈从 FP 寄存器标注开始
- 被调用函数栈从 SP 寄存器标注结束

## 6. 寄存器分配建议

- 优先优化函数内部的寄存器使用, 然后才是参数和返回值的寄存器
- 函数内部生命周期跨越其他函数调用的, 优先选择 s0-s7 寄存器
- 函数内部生命周期不跨越其他函数调用的, 优先选择 t0-t7 临时寄存器

