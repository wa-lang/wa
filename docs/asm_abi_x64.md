# 凹汇编语言函数调用约定 - X64 平台

设计目标:

- 兼容 Microsoft X64 ABI/System V AMD64 ABI
- 和C函数可双向调用

内部细节：

- 增加寄存器传递的参与和返回值的内存布局约定
- 栈的参数和返回值根据类型要求对齐
- SP 寄存器必须 16 字节对齐

## Windows 和 Linux 的 ABI 差异

- 参数寄存器: Windos 用 RCX/RDX/R8/R9, Linux 用 RDI/RSI/RDX/RCX/R8/R9
- 两个返回值: Windows 要走栈空间返回, Linux 下可占用2个寄存器(整数 RAX/RDX, 浮点数 XMM0/XMM1)
- 走栈的多返回值: 返回地址占用第一个参数寄存器, 并且最终地址通过 RAX 返回
- 影子空间: Windows 必须预留 32 字节影子, Linux 则不需要
- 外部函数名: Windows 下通常带下划线(如 `_exit`), 通常不带(如 `exit`)
- 栈对齐: 调用前都需要 16 字节对齐

## Microsoft X64 ABI

- 每个标量在栈上的空间都是8个字节
- 栈指针 rsp 必须保持 16 字节对齐
- 整数参数: rcx, rdx, r8, r9, stack(右到左入栈)
- 浮点数参数: xmm0-xmm3, stack(右到左入栈)
- 返回值(8字节以内): rax(整数/地址), xmm0(浮点数)
- 返回值(大于8字节): 返回值地址作为第一个参数传入, 占用 rcx 输入参数寄存器, 并通过 rax 返回该地址
- 调用者保存: rax, rcx, rdx, r8-r11, xmm0-xmm5
- 被调用者保存: rbx, rbp, rdi, rsi, rsp, r12-r15, xmm6, xmm7
- 调用者需要在栈上准备 32 字节的影子空间, 被调用函数可以使用
- 系统调用编号不稳定

```
+--------+
|  retN  |
|  ....  |
|  ret1  |
|  ret0  | 走栈返回时, 该值由 rcx 定位. 被调用函数不能假设这个地址所在的位置
+--------+ <--- 走栈的返回值地址由 rcx 传入
|  ....  |
|  arg4  | 参数走栈
+--------+
|  arg3  | 影子空间/参数走寄存器
|  arg2  | 影子空间/参数走寄存器
|  arg1  | 影子空间/参数走寄存器
|  arg0  | 影子空间/参数走寄存器/走栈返回时备份栈地址
+--------+<--- rsp, assert(rsp%16) == 0
|  rip   | 函数返回地址, 由 call 指令入栈
|  rbp   | 调用函数栈帧备份, 被调用函数入栈, 此时 rsp 完成 16 字节对齐
+--------+<--- rbp
| .ret0. | 返回值的影子空间, 基于 rbp 定位, 相对位置固定.
+--------+
| local0 | 局部变量 基于 rbp 定位, 相对位置固定
| local1 |
| ...... |
+--------+
| .call. | 调用其他函数, 输入参数和返回值对应的栈空间
| ...... | 该处基于 rsp 定位, 相对位置固定
+--------+<--- rsp, assert(rsp%16) == 0
```

走寄存器传递的参数个数最多有4个.

## System V AMD64 ABI

- 每个标量在栈上的空间都是8个字节
- 栈指针 rsp 必须是对齐到 16 字节
- 整数参数: rdi, rsi, rdx, rcx, r8, r9, stack(右到左入栈)
- 浮点数参数: xmm0-xmm7, stack(右到左入栈)
- 返回值(16字节以内): rax/rdx(整数), xmm0/xmm1(浮点数)
- 返回值(大于16字节): 返回值地址作为第一个参数传入, 占用 rdi 输入参数寄存器, 并通过 rax 返回该地址
- 调用者保存: rax, rdi, rsi, rdx, rcx, r8-r11
- 被调用者保存: RBX, RBP, R12-R15
- rsp 之下有 128 字节的区域被称为 RedZone, 可临时使用

```
+--------+
|  retN  |
|  ....  |
|  ret1  |
|  ret0  |
+--------+<--- 走栈的返回值地址由 rdi 传入
|  ....  |
|  argx  | 走栈传递的输入参数
|  ....  |
+--------+<--- rsp, assert(rsp%16) == 0
|  rip   | 函数返回地址, 由 call 指令入栈
|  rbp   | 调用函数栈帧备份, 被调用函数入栈, 此时 rsp 完成 16 字节对齐
+--------+<--- rbp
| local0 | 局部变量 基于 rbp 定位, 相对位置固定
| local1 |
| ...... |
+--------+
|  arg?  | 影子空间, 由被调用函数自行准备(可选)
|  ....  | 影子空间参数顺序调用函数自行决定
|  arg?  | 影子空间大小需动态计算
|  arg?  |
+--------+
| .call. | 调用其他函数, 输入参数和返回值对应的栈空间
| ...... | 该处基于 rsp 定位, 相对位置固定
+--------+<--- rsp, assert(rsp%16) == 0
```

走寄存器传递的参数个数最多有 6+8=14 个.
