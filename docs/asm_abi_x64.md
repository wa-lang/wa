# 凹汇编语言函数调用约定 - X64 平台

设计目标:

- 兼容 Microsoft X64 ABI/System V AMD64 ABI
- 和C函数可双向调用

内部细节：

- 增加寄存器传递的参与和返回值的内存布局约定
- 栈的参数和返回值根据类型要求对齐
- SP 寄存器必须 16 字节对齐

## Microsoft X64 ABI

- 栈指针 rsp 必须保持 16 字节对齐
- 整数参数: rcx, rdx, r8, r9, stack(右到左入栈)
- 浮点数参数: xmm0-xmm3, stack(右到左入栈)
- 返回值: rax(整数/地址), xmm0(浮点数)
- 调用者保存: rax, rcx, rdx, r8-r11, xmm0-xmm5
- 被调用者保存: rbx, rbp, rdi, rsi, rsp, r12-r15
- 调用者需要在栈上准备 32 字节的影子空间, 被调用函数可以使用
- 系统调用编号不稳定

```
+--------+
|  ....  |
|  arg4  | 参数走栈
+--------+
|  arg3  | 影子空间/参数走寄存器
|  arg2  | 影子空间/参数走寄存器
|  arg1  | 影子空间/参数走寄存器
|  arg0  | 影子空间/参数走寄存器
+--------+<--- rsp
|  rip   | 函数返回地址
|  rbp   | 调用函数栈帧备份
+--------+<--- rbp
|  retN  |
|  ....  |
|  ret1  |
|  ret0  |
+--------+<--- 返回值变量, 也用于栈返回结果
| ...... |
| local1 | 局部变量
| local0 | local0 对齐到 16 字节为 SP
+--------+<--- rsp
```

走寄存器传递的参数个数最多有4个.

## System V AMD64 ABI

- 栈指针 rsp 必须是对齐到 16 字节
- 整数参数: rdi, rsi, rdx, rcx, r8, r9, stack(右到左入栈)
- 浮点数参数: xmm0-xmm7, stack(右到左入栈)
- 返回值: rax(整数/地址), xmm0(浮点数)
- 调用者保存: rax, rdi, rsi, rdx, rcx, r8-r11
- 被调用者保存: RBX, RBP, R12-R15
- rsp 之下有 128 字节的区域被称为 RedZone, 可临时使用

```
+--------+
|  ....  |
|  argx  | 走栈传递的输入参数
|  ....  |
+--------+<--- rsp
|  rip   | 函数返回地址
|  rbp   | 调用函数栈帧备份
+--------+<--- rbp, 以下走寄存器返回
|  retN  |
|  ....  |
|  ret1  |
|  ret0  |
+--------+<--- 返回值变量, 也用于栈返回结果
|  argx  |
|  ....  |
|  arg1  |
|  arg0  |
+--------+<--- 走寄存器参数的备份空间
| ...... |
| local1 | 局部变量
| local0 | local0 对齐到 16 字节为 SP
+--------+<--- rsp
```

走寄存器传递的参数个数最多有 6+8=14 个.
