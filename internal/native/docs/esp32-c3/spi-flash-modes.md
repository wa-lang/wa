# SPI 闪存模式

ESP 芯片支持四种不同的 SPI 闪存访问模式：DIO、DOUT、QIO 和 QOUT。这些可以通过 `esptool write-flash` 的 `--flash-mode` 选项设置。

这些选项控制使用多少个 I/O 引脚与附加的 SPI 闪存芯片通信，以及使用哪些 SPI 命令。

ESP 芯片在从 SPI 闪存芯片读取或执行代码和数据时使用这些命令。数据被读取然后缓存在芯片内部。

## 摘要

按性能顺序：

| 选项 | 模式名称 | 使用的引脚 | 速度（ESP 设备） |
| ------ | --------- | --------- | ------------------ |
| qio    | 四路 I/O  | 4 个引脚用于地址和数据 | 最快。 |
| qout   | 四路输出 | 4 个引脚用于数据。 | 比 qio 慢约 15%。 |
| dio    | 双路 I/O | 2 个引脚用于地址和数据 | 比 qio 慢约 45%。 |
| dout   | 双路输出 | 2 个引脚用于数据。 | 比 qio 慢约 50%。 |

通常，为 `--flash-mode` 选择适用于您设备的最快选项。并非所有设备都支持所有模式。详情见下面的 FAQ。

## 模式描述

### 普通 SPI

传统的“单”SPI（串行外设接口）总线使用 4 个引脚进行通信：

- 时钟（CLK）
- 主机输出从机输入（MOSI）
- 主机输入从机输出（MISO）
- 片选（CS）

[维基百科有相当完整的描述](https://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus)。

所有这些信号都是单向的。在单 SPI 模式下，数据通过 MISO 引脚从设备发送到主机，通过 MOSI 引脚从主机发送到设备。

普通 SPI 的最大数据速率是时钟速率（以位为单位）——因此 40MHz 时钟 = 40Mbits/sec = 5Mbytes/sec。

### 双 SPI

为了提高性能，SPI 闪存制造商引入了“双 SPI”。在双 SPI 模式下，MOSI 和 MISO 引脚都用于同时读写数据，每个时钟周期两位。与单 SPI 相比，这使某些命令的数据速率加倍。

在 `dout` 模式下，主机使用“双输出快速读取”（3BH）命令读取数据。每个读取命令和读取地址通过普通 SPI 从主机发送到闪存芯片，但随后主机通过 MOSI 和 MISO 引脚同时读取数据，每个时钟两位。与仅使用 MISO 读取数据的单 SPI 相比，这将数据传输速率提高了一倍。

在 `dio` 模式下，主机使用“双 I/O 快速读取”（BBH）命令读取数据。每个读取命令通过普通 SPI 从主机发送到闪存芯片，但随后地址通过 MOSI 和 MISO 引脚以每个时钟两位的方式发送到闪存芯片。之后，主机以与“双输出快速读取”相同的方式以每个时钟两位的方式读取数据位。

对于 ESP 芯片，每个命令读取 32 字节，`dio` 模式比 `dout` 模式快约 5%。

请参考您特定 SPI 闪存芯片的数据手册，确定它是否支持这些命令中的一个或两个。

### 四路 SPI

为了进一步提高 SPI 闪存数据传输的性能，SPI 闪存制造商引入了“四路 SPI”模式。此模式增加了两个额外的引脚（否则用于闪存芯片的 `WP` 和 `HOLD` 信号）用于数据传输。这使得双 SPI 的数据速率加倍。

并非所有闪存芯片都支持四路 SPI 模式，也并非所有 ESP 芯片都将这些引脚连接到 SPI 闪存芯片。有些闪存芯片需要特殊命令才能启用四路模式（见下文）。

在 `qout` 模式下，主机使用“四路输出快速读取”（6BH）命令读取数据。此命令与“双输出快速读取”相同，只是数据在 4 个引脚上读取，而不是 2 个引脚，每个时钟周期 4 位。这使得数据传输正好是“双输出快速读取”的两倍快。

在 `qio` 模式下，主机使用“四路 I/O 快速读取”（EBH）命令读取数据。此命令与“双 I/O 快速读取”相同，只是地址和数据都在 4 个引脚上传输，而不是 2 个引脚，每个时钟周期 4 位。这使得地址和数据传输都正好是“双 I/O 快速读取”的两倍快。

## 常见问题

### 为什么 qio 和 qout 模式不能与我的 Espressif 芯片/模块一起使用？

通常是以下原因之一：

- SPI 闪存芯片的 WP 和 HOLD 引脚没有连接到 Espressif 芯片的正确 GPIO。这些引脚必须正确连接才能使四路模式工作，并且并非所有开发板/模块都连接它们。
- SPI 闪存芯片不支持四路模式。查阅闪存芯片数据手册，了解它支持哪些模式。您可以直观地识别闪存芯片，或使用 esptool flash-id 命令。
- 此芯片型号的四路模式未正确启用。SPI 闪存不是标准的，因此每个制造商对其芯片的实现都不同。大多数闪存芯片需要发送特定命令才能启用四路 SPI 模式，并且这些命令各不相同。对于 Espressif 芯片，这通常意味着芯片首先以双 SPI 模式启动，然后软件检测芯片类型并尝试启用正确的四路 SPI 模式。如果软件不支持特定的芯片型号，则无法进入四路模式。

### 为什么 qout/dout 模式有效但 qio/dio 模式无效？

某些 SPI 闪存芯片型号仅支持“双输出快速读取”和/或“四路输出快速读取”命令，不支持其双 I/O 和四路 I/O 等效命令。

### 我的代码在双 SPI 模式下运行速度会是四路 SPI 的一半吗？

不会。Espressif 芯片直接从闪存执行代码，但是由于从闪存读取速度较慢，数据会透明地缓存在 RAM 中。仅当发生缓存未命中时才发送闪存读取命令。但是，用双 SPI 读取填充缓存的速度大约是其四路 SPI 等效速度的一半。

如果您不能使用四路 SPI 模式，请确保您配置了在您的开发板/模块上可靠工作的最快 SPI 闪存时钟速率。80MHz SPI 时钟在双 I/O 模式下比 40MHz SPI 时钟在四路 I/O 模式下更快。

### 闪存模式如何传达给 Espressif 芯片？

闪存到 SPI 闪存的引导加载程序 .bin 文件包含一个头部，其中包含闪存速度、闪存模式和其他一些元数据。初始主机模式由 ROM 代码在复位后读取此头部时确定。将 `--flash-mode` 参数传递给 esptool 将在文件写入闪存时更新此头部。

这仅确定复位时初始启动所使用的模式。软件随后可能会在启动过程中不同地配置闪存模式。

例如，在 ESP32 上，如果 ESP-IDF 配置为 qio/qout 模式，则 IDF 软件引导加载程序实际上是以 dio/dout 模式闪存的。当 ROM 代码从闪存启动此引导加载程序时，引导加载程序软件会检查闪存芯片型号并为其余启动过程启用正确的四路 SPI 模式。这是因为在不同的芯片型号上启用四路 SPI 有多种不同的方式。

